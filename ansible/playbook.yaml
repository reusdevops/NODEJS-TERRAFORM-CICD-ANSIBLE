---
- name: Deploy Node.js Application
  hosts: all
  become: true
  
  vars_files:
    - "vars/{{ ENVIRONMENT }}_secrets.yaml"
    - "vars/{{ ENVIRONMENT }}_main.yaml"
  
  vars:
    # Default values (overridden by GitHub Actions -e flags)
    DOCKER_IMAGE_NAME: "web-app"
    DOCKER_IMAGE_TAG: "latest"
    ENVIRONMENT: "dev"
    
    # Computed variables
    docker_image_full: "{{ dockerhub_username }}/{{ DOCKER_IMAGE_NAME }}:{{ DOCKER_IMAGE_TAG }}"
    container_name: "{{ DOCKER_IMAGE_NAME }}-{{ ENVIRONMENT }}"

  pre_tasks:
    - name: Display deployment information
      debug:
        msg: |
          ============================================
          DEPLOYMENT CONFIGURATION
          ============================================
          Environment: {{ ENVIRONMENT }}
          Docker Image: {{ docker_image_full }}
          Container Name: {{ container_name }}
          Host Port: {{ host_port }}
          Container Port: {{ container_port }}
          Git SHA: {{ DOCKER_IMAGE_TAG }}
          ============================================

    - name: Check if Docker is installed
      command: docker --version
      register: docker_check
      ignore_errors: true
      changed_when: false
      
    - name: Display Docker status
      debug:
        msg: |
          Docker Status:
          - Return Code: {{ docker_check.rc }}
          - Output: {{ docker_check.stdout if docker_check.rc == 0 else docker_check.stderr }}
          - Docker Installation Needed: {{ docker_check.rc != 0 }}

  roles:
    - role: geerlingguy.docker
      when: docker_check.rc != 0
      vars:
        docker_users: 
          - reus
        docker_install_compose: true
        docker_daemon_options:
          log-driver: "json-file"
          log-opts:
            max-size: "10m"
            max-file: "3"

  tasks:
    - name: Verify Docker Hub credentials
      debug:
        msg: "Docker Hub Username: {{ dockerhub_username }}"
  
    - name: Log in to Docker Hub
      community.docker.docker_login:
        username: "{{ dockerhub_username }}"
        password: "{{ dockerhub_password }}"
        registry_url: "https://index.docker.io/v1/"
      # no_log: true  # Hide sensitive output

    - name: Pull latest Docker image
      community.docker.docker_image:
        name: "{{ dockerhub_username }}/{{ DOCKER_IMAGE_NAME }}"
        tag: "{{ DOCKER_IMAGE_TAG }}"
        source: pull
        force_source: yes
      register: image_pull_result

    - name: Display image pull result
      debug:
        msg: "Successfully pulled image: {{ docker_image_full }}"
      when: image_pull_result is succeeded

    - name: Getting running container's info
      community.docker.docker_host_info:
        containers: yes
      register: docker_containers_info
    
    - name: Displaying running containers
      debug:
        msg: docker_containers_info

    - name: Get current container status
      community.docker.docker_container_info:
        name: "{{ container_name }}"
      register: container_info
      ignore_errors: true

    - name: Display current container info
      debug:
        msg: |
          Current Container Status:
          - Exists: {{ container_info.exists }}
          - Running: {{ container_info.container.State.Running if container_info.exists else 'N/A' }}
          - Image: {{ container_info.container.Config.Image if container_info.exists else 'N/A' }}
      when: container_info.exists

    - name: Stop existing container
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: stopped
      when: container_info.exists and container_info.container.State.Running
      ignore_errors: true

    - name: Remove existing container for clean deployment
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent
      when: container_info.exists
      ignore_errors: true

    - name: Deploy Docker container
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ docker_image_full }}"
        state: started
        restart_policy: unless-stopped
        ports:
          - "{{ host_port }}:{{ container_port }}"
        env:
          NODE_ENV: "{{ ENVIRONMENT }}"
          APP_VERSION: "{{ DOCKER_IMAGE_TAG }}"
          PORT: "{{ container_port }}"
        labels:
          app: "{{ DOCKER_IMAGE_NAME }}"
          environment: "{{ ENVIRONMENT }}"
          version: "{{ DOCKER_IMAGE_TAG }}"
          deployed_at: "{{ ansible_date_time.iso8601 }}"
          deployed_by: "ansible"
        pull: false  # Already pulled above
        detach: true
        healthcheck:
          test: ["CMD-SHELL", "curl -f http://localhost:{{ container_port }} || exit 1"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 40s
      register: container_deploy

    - name: Wait for container to be healthy
      command: docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ container_name }}
      register: health_status
      until: health_status.stdout == "healthy"
      retries: 12
      delay: 5
      changed_when: false
      when: container_deploy is succeeded

    - name: Verify application is responding
      uri:
        url: "http://localhost:{{ host_port }}"
        status_code: 200
        timeout: 5
      register: app_response
      retries: 10
      delay: 3
      until: app_response.status == 200

    - name: Display container logs (last 20 lines)
      command: docker logs --tail 20 {{ container_name }}
      register: container_logs
      changed_when: false

    - name: Show container logs
      debug:
        msg: "{{ container_logs.stdout_lines }}"

    - name: Clean up old Docker images (keep last 3 versions)
      shell: |
        docker images {{ dockerhub_username }}/{{ DOCKER_IMAGE_NAME }} --format "{{ '{{' }}.ID{{ '}}' }} {{ '{{' }}.Tag{{ '}}' }}" | \
        grep -v "{{ DOCKER_IMAGE_TAG }}" | \
        tail -n +3 | \
        awk '{print $1}' | \
        xargs -r docker rmi -f
      ignore_errors: true
      when: ENVIRONMENT == "production"
      register: cleanup_result

    - name: Log deployment to file
      lineinfile:
        path: "/var/log/{{ DOCKER_IMAGE_NAME }}-deployments.log"
        line: "{{ ansible_date_time.iso8601 }} | {{ ENVIRONMENT }} | {{ DOCKER_IMAGE_TAG }} | {{ dockerhub_username }}/{{ DOCKER_IMAGE_NAME }}:{{ DOCKER_IMAGE_TAG }} | {{ ansible_user }}"
        create: yes
        mode: '0644'

    - name: Deployment summary
      debug:
        msg: |
          ============================================
          DEPLOYMENT SUCCESSFUL
          ============================================
          Container Name: {{ container_name }}
          Image: {{ docker_image_full }}
          Status: {{ container_deploy.container.State.Status }}
          Ports: {{ host_port }}:{{ container_port }}
          Health: {{ health_status.stdout | default('pending') }}
          Application URL: http://{{ ansible_default_ipv4.address }}:{{ host_port }}
          ============================================

  post_tasks:
    - name: Send deployment notification (optional)
      debug:
        msg: "Deployment of {{ docker_image_full }} to {{ ENVIRONMENT }} completed successfully!"