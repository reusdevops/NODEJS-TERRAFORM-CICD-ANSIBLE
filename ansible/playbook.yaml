---
- name: Deploying application
  hosts: all
  become: true # This allows Ansible to use sudo
  vars_files:
    - "vars/{{ ENVIRONMENT }}_secrets.yaml"
    - "vars/{{ ENVIRONMENT }}_main.yaml"

  pre_tasks:
    # === QUICK DOCKER CHECK ===
    - name: Check docker version
      command: docker --version
      register: docker_check
      ignore_errors: true
      changed_when: false
      
    - name: show message
      debug:
        msg: |
          - docker --version return code: {{ docker_check.rc }}
          - Output: {{ docker_check.stdout if docker_check.rc == 0 else docker_check.stderr }}
          - docker_needs_install : {{ docker_check.rc != 0 }}

  roles:
    - role: geerlingguy.docker
      when: docker_check.rc != 0
      vars:
        docker_users: 
          - reus
        docker_install_compose: true
        docker_daemon_options:
          log-driver: "json-file"
          log-opts:
            max-size: "10m"
            max-file: "3"

  tasks:
    # - name: Ensure nginx is installed
    #   apt:
    #     name: nginx
    #     state: present
    #     update_cache: yes
    - name: Check vars
      debug:
        msg: "dockerhub username is {{ dockerhub_username }}"
  
    - name: Log in to Docker Hub
      docker_login:
        username: "{{ dockerhub_username }}"
        password: "{{ dockerhub_password }}"
        registry_url: "https://index.docker.io/v1"
    # - name: Getting container's port
    #   set_fact:
    #     current_port: docker inspect -f '{{(index (index .NetworkSettings.Ports "3000/tcp") 0).HostPort}}' movie-app-blue

    # - name: Determine ports for deployment
    #   set_fact:
    #     current_port: "{{ current_port_check.stdout | default('8081') }}"
    #     new_port: "{{ '8081' if current_port_check.stdout == '8080' else '8080' }}"
    #     old_container: "{{ 'web-app-blue' if current_port_check.stdout == '8080' else 'web-app-green' }}"
    #     new_container: "{{ 'web-app-green' if current_port_check.stdout == '8080' else 'web-app-blue' }}"

    # -   name: Download image from docker Hub
    #     docker_image:
    #       name: phyolwinlwinlatt/web-app
    #       tag: latest
    #       state: present
    #       source: pull
    #       force_source: yes  # Always pull latest version
    #     tags: ['docker', 'images', 'download']

    - name: Stop existing container (if running)
      docker_container:
        name: web-app
        state: stopped
      ignore_errors: true  # Don't fail if container doesn't exist
      tags: ['docker', 'stop', 'container']

    - name: Remove existing container (optional - for clean restart)
      docker_container:
        name: web-app
        state: absent
      ignore_errors: true  # Don't fail if container doesn't exist
      tags: ['docker', 'remove', 'containers']
      when: true # Set to true if you want to remove old container

    - name: Create and run Docker container
      docker_container:
        name: web-app
        image: "{{ dockerhub_username }}/web-app:latest"
        state: started
        restart_policy: unless-stopped
        ports: "{{ host_port }}:{{ container_port }}"
        # Additional container options
        pull: no  # Don't pull again, we already pulled above
        detach: yes
        interactive: no
        tty: no
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:${{ container_port }}"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 40s










  #   - name: Update apt cache
  #     apt:
  #       update_cache: yes
  #       cache_valid_time: 3600
  #     tags: ['docker', 'update']

  #   - name: Install Docker using docker_host module
  #     docker_host:
  #       state: present
  #       docker_daemon_config:
  #         log-driver: "json-file"
  #         log-opts:
  #           max-size: "10m"
  #           max-file: "3"
  #     tags: ['docker', 'install']

  #   - name: Add users to docker group
  #     user:
  #       name: reus
  #       groups: docker
  #       append: yes
  #     tags: ['docker', 'users']

  #   - name: Test Docker installation
  #     docker_container:
  #       name: hello-world-test
  #       image: hello-world
  #       state: started
  #       detach: no
  #       cleanup: yes
  #     tags: ['docker', 'test']
